<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>جنگ دار | سیستم فرماندهی تاکتیکی پیشرفته</title>
    <style>
        /* --- متغیرها و فونت --- */
        @font-face {
            font-family: 'Vazirmatn';
            src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn/v1.3.0/dist/font-files/vazirmatn-regular.woff2') format('woff2');
            font-weight: 400;
            font-style: normal;
        }
        :root {
            --color-bg: #0d0d0d;
            --color-surface: #1a1a1a;
            --color-text: #e0e0e0;
            --color-primary: #00ff99; /* سبز روشن (Hacker Green) */
            --color-secondary: #333333;
            --color-error: #ff6b6b;
            --font-family: 'Vazirmatn', sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--color-bg);
            color: var(--color-text);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        /* --- طرح‌بندی اصلی --- */
        #main-container {
            width: 100%;
            max-width: 1400px;
            display: grid;
            grid-template-columns: 1fr 2fr; /* نقشه/وضعیت در چپ، کنسول در راست */
            gap: 30px;
            align-items: start;
        }

        /* --- ستون چپ: نقشه و وضعیت بات‌ها --- */
        #side-panel {
            background-color: var(--color-surface);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--color-secondary);
        }
        
        .panel-header {
            color: var(--color-primary);
            border-bottom: 1px solid var(--color-secondary);
            padding-bottom: 10px;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        /* نقشه SVG مینیمال */
        #interactive-map-container {
            margin-bottom: 20px;
            text-align: center;
        }
        
        #war-map {
            width: 100%;
            height: auto;
            background-color: #2a2a2a; /* رنگ پس‌زمینه نقشه */
            border-radius: 8px;
            border: 1px solid #444;
        }
        
        .map-region {
            fill: #444; /* رنگ پیش‌فرض مناطق */
            stroke: var(--color-bg);
            stroke-width: 1px;
            transition: fill 0.3s, stroke 0.3s, transform 0.1s;
            cursor: pointer;
        }
        
        .map-region:hover {
            fill: var(--color-primary);
            transform: scale(1.01);
        }
        
        .map-region.selected {
            fill: var(--color-primary) !important;
            stroke: var(--color-text);
            stroke-width: 2px;
            animation: pulse 1s infinite alternate;
        }

        @keyframes pulse {
            from { opacity: 1; }
            to { opacity: 0.7; }
        }

        /* وضعیت بات‌ها */
        .bot-status {
            margin-top: 20px;
        }

        .bot-card {
            background-color: var(--color-bg);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid transparent;
            transition: border-left 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }

        .bot-card.neutral { border-left-color: #888; }
        .bot-card.hostile { border-left-color: var(--color-error); }
        .bot-card.ally { border-left-color: var(--color-primary); }
        .bot-card.defeated { border-left-color: #333; opacity: 0.6; cursor: default;}
        .bot-card:hover { box-shadow: 0 0 10px rgba(0, 255, 153, 0.3); }
        .bot-card.defeated:hover { box-shadow: none; }

        .bot-name { font-weight: bold; font-size: 1.1rem; margin-bottom: 5px; }
        .bot-power { font-size: 0.9rem; color: #aaa; }

        /* --- ستون راست: کنسول فرماندهی --- */
        #command-area {
            background-color: var(--color-surface);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--color-secondary);
        }

        #output-console {
            min-height: 350px;
            max-height: 50vh;
            overflow-y: auto;
            padding: 15px;
            background-color: rgba(0, 0, 0, 0.4); 
            border: 1px solid var(--color-secondary);
            border-radius: 8px;
            text-align: right;
            direction: rtl;
            white-space: pre-wrap; 
            font-family: monospace;
            color: var(--color-primary);
            margin-bottom: 15px;
        }
        
        .console-prompt { color: #ccc; }
        .console-action { color: var(--color-primary); }
        .console-result { color: #e0e0e0; }
        .console-danger { color: var(--color-error); }
        .console-system { color: #00bfff; }

        .action-menu {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        .action-button {
            flex-grow: 1;
            padding: 12px 15px;
            background-color: var(--color-primary);
            color: var(--color-bg);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .action-button:hover {
            background-color: #00cc88;
        }
        .action-button:disabled {
            background-color: #333;
            color: #888;
            cursor: not-allowed;
        }
        
        /* --- مودال بازار --- */
        .modal {
            display: none; 
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
        }

        .modal-content {
            background-color: var(--color-surface);
            margin: 10% auto;
            padding: 25px;
            border: 1px solid var(--color-primary);
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 5px 15px rgba(0, 255, 153, 0.5);
            text-align: right;
            direction: rtl;
        }

        .close-button {
            color: var(--color-error);
            float: left;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .market-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px dotted #444;
            align-items: center;
        }

        .market-item button {
            padding: 5px 10px;
            background-color: var(--color-primary);
            color: var(--color-bg);
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        
        /* ریسپانسیو */
        @media (max-width: 900px) {
            #main-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <div id="main-container">
        
        <!-- ستون چپ: نقشه و وضعیت بات‌ها -->
        <div id="side-panel">
            <div class="panel-header">۱. انتخاب پایگاه فرماندهی (نقشه)</div>
            
            <div id="interactive-map-container">
                <svg id="war-map" viewBox="0 0 800 400" xmlns="http://www.w3.org/2000/svg">
                    <rect id="region-A" class="map-region" data-country-id="persia" x="50" y="100" width="150" height="120" />
                    <rect id="region-B" class="map-region" data-country-id="axis" x="250" y="50" width="100" height="100" />
                    <rect id="region-C" class="map-region" data-country-id="allies" x="400" y="150" width="200" height="150" />
                    <rect id="region-D" class="map-region" data-country-id="neutral" x="650" y="80" width="120" height="100" />
                    
                    <text x="125" y="165" class="map-label" fill="#ffffff" text-anchor="middle" font-size="16">ایران</text>
                    <text x="300" y="105" class="map-label" fill="#ffffff" text-anchor="middle" font-size="16">بات A</text>
                    <text x="500" y="225" class="map-label" fill="#ffffff" text-anchor="middle" font-size="16">بات B</text>
                    <text x="710" y="130" class="map-label" fill="#ffffff" text-anchor="middle" font-size="16">بات C</text>
                </svg>
            </div>
            
            <div class="panel-header">۲. وضعیت نیروهای دشمن</div>
            <div id="bot-status-display" class="bot-status">
                <!-- کارت‌های بات‌ها توسط JS اینجا قرار می‌گیرند -->
            </div>
        </div>

        <!-- ستون راست: کنسول فرماندهی -->
        <div id="command-area">
            
            <div class="panel-header">۳. منابع و فرمان‌ها</div>
            <div id="status-bar" style="padding: 10px; border: 1px solid #444; border-radius: 5px; margin-bottom: 15px;">
                <!-- وضعیت منابع اینجا نمایش داده می‌شود -->
            </div>
            
            <div class="action-menu">
                <button id="btn-scan" class="action-button" disabled>اسکن وضعیت</button>
                <button id="btn-engage" class="action-button" disabled>درگیری با هدف</button>
                <button id="btn-market" class="action-button" disabled>بازار و اقتصاد</button> 
                <button id="btn-end-day" class="action-button" style="background-color: var(--color-error); color: white;">پایان روز</button>
            </div>

            <div class="panel-header" style="margin-top: 20px;">۴. کنسول عملیات (JANGDAR_OS)</div>
            <div id="output-console">
                <span class="console-prompt">[[JANGDAR_OS v3.3 - FIXED]] &gt;</span> 
                منتظر انتخاب پایگاه فرماندهی از نقشه...
            </div>
            
        </div>

    </div>

    <!-- مودال بازار -->
    <div id="marketModal" class="modal">
      <div class="modal-content">
        <span class="close-button">&times;</span>
        <div class="panel-header">بازار و مدیریت منابع</div>
        
        <h4>۱. عملیات اقتصادی</h4>
        <div id="economy-ops" style="margin-bottom: 20px;">
            <div class="market-item">
                <span>تنظیم مالیات (تأثیر بر درآمد روزانه):</span>
                <input type="number" id="tax-rate" value="10" min="0" max="50" style="width: 60px; background: #222; color: white; border: 1px solid #444; padding: 5px; border-radius: 3px;"> %
                <button onclick="applyTax()">اعمال مالیات</button>
            </div>
            
            <div class="market-item">
                <span>درآمد روزانه (بر اساس مالیات):</span>
                <span id="daily-income">0</span> واحد
            </div>
        </div>

        <h4>۲. خرید آیتم‌ها</h4>
        <div id="market-list">
            <!-- آیتم‌های خرید/فروش توسط JS اضافه می‌شوند -->
        </div>
      </div>
    </div>

    <script>
        const mapRegions = document.querySelectorAll('.map-region');
        const botStatusDisplay = document.getElementById('bot-status-display');
        const consoleElement = document.getElementById('output-console');
        const btnScan = document.getElementById('btn-scan');
        const btnEngage = document.getElementById('btn-engage');
        const btnMarket = document.getElementById('btn-market');
        const btnEndDay = document.getElementById('btn-end-day');
        const statusBar = document.getElementById('status-bar');
        
        // --- وضعیت بازی ---
        let selectedCountryId = 'none';
        let selectedBotIndex = -1;
        let dayCount = 1;
        let taxRate = 10; // درصد
        let gameActive = true; 
        
        let gameState = {
            money: 5000,
            mines: 1, 
            power: 850, // این مقدار در ابتدای هر روز با منطقه انتخابی تنظیم می‌شود
            espionage_tokens: 0,
            nuclear_missiles: 0
        };
        
        const MARKET_PRICES = {
            mine_buy: 1500,
            mine_sell: 800,
            base_power_boost: 500, 
            daily_income_base: 100,
            espionage_cost: 1200,
            nuke_cost: 10000,
            espionage_power_debuff: 150,
        };

        const countryPowerMap = {
            'persia': { name: "ایران (پایگاه اصلی)", power: 850, initialBotStatus: "ally" },
            'axis':   { name: "منطقه دشمن (Axis)", power: 400, initialBotStatus: "hostile" },
            'allies': { name: "منطقه متفقین (Allies)", power: 550, initialBotStatus: "neutral" },
            'neutral':{ name: "منطقه بی‌طرف", power: 200, initialBotStatus: "neutral" }
        };

        const bots = [
            { name: "بات تاکتیکی - شبکه S-1", power: 350, status: "hostile", id: 0 },
            { name: "بات استراتژیک - هسته مرکزی", power: 500, status: "hostile", id: 1 },
            { name: "بات پشتیبانی - لجستیک", power: 150, status: "neutral", id: 2 }
        ];

        // --- توابع کمکی کنسول و UI ---
        function logToConsole(message, type = 'info') {
            const formattedMessage = `<div class="${type}">${message}</div>`;
            consoleElement.innerHTML += formattedMessage;
            consoleElement.scrollTop = consoleElement.scrollHeight;
        }

        function logPrompt(action) {
            const currentContext = selectedCountryId === 'persia' ? countryPowerMap[selectedCountryId].name : (selectedCountryId === 'none' ? `Day ${dayCount}` : 'Operation');
            const prompt = `<span class="console-prompt">[[${currentContext}]] &gt;</span> <span class="console-action">${action}</span>`;
            logToConsole(prompt, 'action');
        }
        
        function updateStatusBar() {
            const baseIncome = gameState.mines * MARKET_PRICES.daily_income_base;
            const taxAmount = Math.floor(baseIncome * (taxRate / 100));
            const netIncome = baseIncome - taxAmount;
            
            document.getElementById('daily-income').textContent = netIncome.toLocaleString() + " تومان";
            
            statusBar.innerHTML = `
                <strong>روز: ${dayCount}</strong> | 
                پول: ${gameState.money.toLocaleString()} تومان | 
                معادن: ${gameState.mines} | 
                قدرت پایگاه: ${gameState.power.toLocaleString()} | 
                مالیات: ${taxRate}% (${netIncome.toLocaleString()} درآمد روزانه) | 
                جاسوسی: ${gameState.espionage_tokens} | 
                موشک هسته‌ای: ${gameState.nuclear_missiles}
            `;
        }
        
        function setButtonStates(active) {
            // اگر بازی فعال نیست، همه را غیرفعال کن
            if (!gameActive) {
                 btnScan.disabled = true;
                 btnEngage.disabled = true;
                 btnMarket.disabled = true;
                 btnEndDay.disabled = true;
                 return;
            }
            
            // وضعیت عادی
            btnScan.disabled = active ? (selectedCountryId === 'none') : true;
            btnEngage.disabled = active ? (selectedBotIndex === -1 || bots[selectedBotIndex]?.status === 'defeated') : true;
            btnMarket.disabled = !active; 
            btnEndDay.disabled = !active;
        }
        
        function renderBotStatus() {
             botStatusDisplay.innerHTML = '';
             bots.forEach((bot, index) => {
                let statusClass = bot.status;
                if (bot.status === 'defeated') {
                    statusClass = 'defeated';
                } else if (bot.status === 'hostile') {
                    statusClass = 'hostile';
                } else {
                    statusClass = 'neutral';
                }

                const isTarget = index === selectedBotIndex;
                const card = document.createElement('div');
                card.className = `bot-card ${statusClass} ${isTarget ? 'selected' : ''}`;
                card.setAttribute('data-bot-index', index);
                
                let powerText = bot.status === 'defeated' ? 'منهدم' : `${bot.power.toLocaleString()}`;

                card.innerHTML = `
                    <div class="bot-name">${bot.name} ${isTarget ? '<span style="color: yellow;">(هدف انتخاب شده)</span>' : ''}</div>
                    <div class="bot-power">وضعیت: ${bot.status.toUpperCase()} | قدرت: ${powerText}</div>
                `;
                
                if (bot.status !== 'defeated') {
                    card.addEventListener('click', () => {
                        if (!gameActive) return;
                        selectedBotIndex = index;
                        logPrompt(`هدف درگیری به ${bot.name} تغییر یافت.`);
                        renderBotStatus(); // برای نمایش انتخاب جدید
                        setButtonStates(true); // برای فعال کردن مجدد دکمه درگیری
                    });
                }
                
                botStatusDisplay.appendChild(card);
             });
        }


        // --- عملیات بازار (Market Modal) ---
        const marketModal = document.getElementById('marketModal');
        const closeButton = document.querySelector('.close-button');
        const marketList = document.getElementById('market-list');

        closeButton.onclick = () => marketModal.style.display = "none";
        window.onclick = (event) => {
            if (event.target == marketModal) {
                marketModal.style.display = "none";
            }
        }
        
        function renderMarket() {
            marketList.innerHTML = '';
            
            marketList.innerHTML += `
                <div class="market-item">
                    <span>خرید معدن (قیمت: ${MARKET_PRICES.mine_buy.toLocaleString()}):</span>
                    <button onclick="buyResource('mine')">خرید (X1)</button>
                </div>
            `;
            
             marketList.innerHTML += `
                <div class="market-item">
                    <span>افزایش قدرت تاکتیکی (قیمت: ${MARKET_PRICES.base_power_boost.toLocaleString()}):</span>
                    <button onclick="buyResource('power_boost')">خرید (X1)</button>
                </div>
            `;
            
            marketList.innerHTML += `
                <div class="market-item">
                    <span>عملیات جاسوسی (قیمت: ${MARKET_PRICES.espionage_cost.toLocaleString()}):</span>
                    <button onclick="buyResource('espionage')" ${gameState.money < MARKET_PRICES.espionage_cost ? 'disabled' : ''}>خرید (X1)</button>
                </div>
            `;
            
            marketList.innerHTML += `
                <div class="market-item" style="color: var(--color-error);">
                    <span>موشک هسته‌ای (قیمت: ${MARKET_PRICES.nuke_cost.toLocaleString()}):</span>
                    <button onclick="buyResource('nuke')" style="background-color: var(--color-error); color: white;" ${gameState.money < MARKET_PRICES.nuke_cost || gameState.nuclear_missiles > 0 ? 'disabled' : ''}>خرید (X1)</button>
                </div>
            `;
            
            if (gameState.mines > 1) {
                 marketList.innerHTML += `
                    <div class="market-item">
                        <span>فروش یک معدن (دریافتی: ${MARKET_PRICES.mine_sell.toLocaleString()}):</span>
                        <button onclick="sellResource('mine')" style="background-color: #888;">فروش (X1)</button>
                    </div>
                `;
            }
            
            updateStatusBar();
        }

        function openMarket() {
            if (!gameActive) return; // **بررسی وضعیت بازی**
            renderMarket();
            marketModal.style.display = "block";
        }
        
        function applyTax() {
            if (!gameActive) return;
            const newTax = parseInt(document.getElementById('tax-rate').value);
            if (isNaN(newTax) || newTax < 0 || newTax > 50) {
                logToConsole("[MARKET ERROR] نرخ مالیات باید بین ۰ تا ۵۰ درصد باشد.", 'danger');
                return;
            }
            taxRate = newTax;
            logPrompt(`نرخ مالیات به ${taxRate}% تنظیم شد.`);
            updateStatusBar();
            renderMarket();
        }
        
        function buyResource(resourceType) {
            if (!gameActive) return;
            // ... (کد خرید منابع بدون تغییر)
            if (resourceType === 'mine') {
                if (gameState.money >= MARKET_PRICES.mine_buy) {
                    gameState.money -= MARKET_PRICES.mine_buy;
                    gameState.mines += 1;
                    logPrompt(`معدن جدید خریداری شد.`);
                } else {
                    logToConsole("[MARKET FAIL] پول کافی برای خرید معدن وجود ندارد.", 'danger');
                }
            } else if (resourceType === 'power_boost') {
                if (gameState.money >= MARKET_PRICES.base_power_boost) {
                    gameState.money -= MARKET_PRICES.base_power_boost;
                    gameState.power += 100; 
                    logPrompt(`قدرت نظامی ${gameState.power.toLocaleString()} واحد افزایش یافت (تأثیر موقت).`);
                } else {
                    logToConsole("[MARKET FAIL] پول کافی برای تقویت قدرت وجود ندارد.", 'danger');
                }
            } else if (resourceType === 'espionage') {
                 if (gameState.money >= MARKET_PRICES.espionage_cost) {
                    gameState.money -= MARKET_PRICES.espionage_cost;
                    gameState.espionage_tokens += 1;
                    logPrompt(`توکن جاسوسی ${gameState.espionage_tokens} خریداری شد. آماده اعمال بر بات هدف در نوبت بعدی.`);
                } else {
                    logToConsole("[MARKET FAIL] پول کافی برای خرید توکن جاسوسی وجود ندارد.", 'danger');
                }
            } else if (resourceType === 'nuke') {
                 if (gameState.money >= MARKET_PRICES.nuke_cost && gameState.nuclear_missiles === 0) {
                    gameState.money -= MARKET_PRICES.nuke_cost;
                    gameState.nuclear_missiles = 1;
                    logPrompt(`موشک هسته‌ای خریداری شد! آماده برای شلیک در روز ۶.`);
                } else if (gameState.nuclear_missiles > 0) {
                    logToConsole("[MARKET FAIL] شما قبلاً یک موشک هسته‌ای خریداری کرده‌اید.", 'danger');
                } else {
                    logToConsole("[MARKET FAIL] پول کافی برای خرید موشک هسته‌ای وجود ندارد.", 'danger');
                }
            }
            updateStatusBar();
            renderMarket();
        }
        
        function sellResource(resourceType) {
            if (!gameActive) return;
            if (resourceType === 'mine' && gameState.mines > 1) {
                gameState.money += MARKET_PRICES.mine_sell;
                gameState.mines -= 1;
                logPrompt(`یک معدن فروخته شد. ${MARKET_PRICES.mine_sell.toLocaleString()} واحد نقدینگی دریافت شد.`);
            }
            updateStatusBar();
            renderMarket();
        }

        // --- عملیات اصلی بازی ---
        
        function handleScan() {
            if (!gameActive) return;
            if (selectedCountryId === 'none') {
                logToConsole("[ERROR] لطفاً ابتدا یک پایگاه فرماندهی را از روی نقشه انتخاب کنید.", 'danger');
                return;
            }
            
            setButtonStates(false); // غیرفعال کردن همه دکمه‌ها در حین عملیات
            const basePower = countryPowerMap[selectedCountryId].power;
            logPrompt(`شروع عملیات اسکن و ارزیابی قدرت در منطقه ${countryPowerMap[selectedCountryId].name}`);
            
            setTimeout(() => {
                logToConsole(`[RESULT] قدرت پایگاه شما (Base Power): ${basePower}`, 'result');
                
                bots.forEach(bot => {
                    logToConsole(`[${bot.name}] | قدرت: ${bot.power.toLocaleString()} | وضعیت: ${bot.status.toUpperCase()}`, 'result');
                });
                
                setButtonStates(true); // فعال‌سازی مجدد
            }, 1500);
        }

        function handleEngage() {
            if (!gameActive) return;
            if (selectedBotIndex === -1 || selectedCountryId === 'none') return;
            
            const targetBot = bots[selectedBotIndex];
            if (targetBot.status === 'defeated') return;

            const basePower = gameState.power; 
            
            setButtonStates(false); // غیرفعال کردن همه دکمه‌ها در حین عملیات
            logPrompt(`شروع درگیری نظامی علیه ${targetBot.name}`);
            
            setTimeout(() => {
                const attackRoll = Math.floor(Math.random() * 100) + 1;
                // فرمول شانس پیروزی کمی تعدیل شد تا وابسته به قدرت شما باشد
                const successChance = Math.min(95, (basePower / (basePower + targetBot.power)) * 100 + 10); 

                logToConsole(`[ENGAGE SIM] شانس تئوری پیروزی: ${successChance.toFixed(1)}%`, 'info');

                let damageDealt = 0;
                let damageTaken = 0;
                
                if (attackRoll < successChance) {
                    damageDealt = Math.floor(basePower * 0.15); 
                    targetBot.power = Math.max(0, targetBot.power - damageDealt);
                    
                    logToConsole(`[SUCCESS] هدف با ضربه مستقیم ${damageDealt.toLocaleString()} واحد تضعیف شد.`, 'result');
                    
                    if (targetBot.power === 0) {
                        logToConsole(`[TERMINATED] واحد ${targetBot.name} کاملاً غیرفعال شد.`, 'danger');
                        targetBot.status = 'defeated';
                    }
                    
                } else {
                    damageTaken = Math.floor(targetBot.power * 0.05); 
                    gameState.power = Math.max(100, gameState.power - damageTaken); 
                    
                    logToConsole(`[FAILURE] پدافند فعال شد. قدرت شما ${damageTaken.toLocaleString()} واحد کاهش یافت.`, 'danger');
                }
                
                renderBotStatus();
                updateStatusBar();
                selectedBotIndex = -1; 
                setButtonStates(true); 
                
            }, 2500);
        }
        
        // --- منطق پایان روز ---
        function applyEspionageDebuff() {
            const activeBots = bots.filter(b => b.status !== 'defeated');
            if (activeBots.length > 0 && gameState.espionage_tokens > 0) {
                const targetBot = activeBots[Math.floor(Math.random() * activeBots.length)];
                const debuff = MARKET_PRICES.espionage_power_debuff;
                targetBot.power = Math.max(50, targetBot.power - debuff);
                gameState.espionage_tokens -= 1;
                
                logToConsole(`[ESPIONAGE SUCCESS] جاسوسی موفقیت‌آمیز بود. قدرت ${targetBot.name} به میزان ${debuff.toLocaleString()} واحد کاهش یافت.`, 'console-danger');
                renderBotStatus();
                return true;
            }
            return false;
        }
        
        function nukeStrike() {
            if (dayCount === 6 && gameState.nuclear_missiles === 1) {
                const activeBots = bots.filter(b => b.status !== 'defeated');
                if (activeBots.length > 0) {
                    const targetBot = activeBots[Math.floor(Math.random() * activeBots.length)];
                    
                    logToConsole(`*** هشدار فوق بحرانی *** موشک هسته‌ای فعال شد! هدف: ${targetBot.name}`, 'console-danger');
                    
                    setTimeout(() => {
                         targetBot.power = 0;
                         targetBot.status = 'defeated';
                         gameState.nuclear_missiles = 0;
                         logToConsole(`[NUCLEAR DETONATION] ${targetBot.name} به طور کامل منهدم شد. اثرات جانبی ناشناخته است...`, 'console-danger');
                         renderBotStatus();
                         updateStatusBar();
                    }, 3000);
                    
                    return true;
                }
            }
            return false;
        }

        function randomBotAction() {
            const activeBots = bots.filter(b => b.status !== 'defeated');
            if (activeBots.length === 0) {
                logToConsole("تمام بات‌ها غیرفعال شدند. پیروزی تاکتیکی.", 'console-system');
                gameActive = false; // **بازی تمام شد**
                return;
            }
            
            const randomBot = activeBots[Math.floor(Math.random() * activeBots.length)];
            const actionType = Math.random();
            
            if (actionType < 0.6) { // 60% شانس حمله
                const attackPower = Math.floor(randomBot.power * (0.8 + Math.random() * 0.4)); 
                
                if (selectedCountryId === 'persia') {
                    gameState.power = Math.max(100, gameState.power - attackPower);
                    logToConsole(`[${randomBot.name} - تهاجم] نیروهای شما مورد حمله قرار گرفتند. ${attackPower.toLocaleString()} واحد قدرت از دست رفت.`, 'console-danger');
                } else {
                    const targetIndex = Math.floor(Math.random() * bots.length);
                    const targetBot = bots[targetIndex];
                    if (targetBot.id !== randomBot.id && targetBot.status !== 'defeated') {
                        targetBot.power = Math.max(50, targetBot.power - Math.floor(attackPower * 0.3));
                        logToConsole(`[${randomBot.name} - درگیری داخلی] بات ${targetBot.name} تضعیف شد (قدرت از دست رفته: ${Math.floor(attackPower * 0.3)}).`, 'console-system');
                    } else {
                         randomBot.power = Math.min(randomBot.power + 50, 1000);
                         logToConsole(`[${randomBot.name} - بازسازی] ${randomBot.name} کمی خود را تقویت کرد.`, 'console-system');
                    }
                }
            } else { // 40% شانس تقویت
                randomBot.power = Math.min(randomBot.power + 100, 1000);
                logToConsole(`[${randomBot.name} - تقویت] ${randomBot.name} موقعیت خود را تثبیت کرد.`, 'console-system');
            }
        }
        
        function advanceDay() {
            if (!gameActive) return;

            // 1. چک کردن باخت
            if (gameState.power <= 100 && selectedCountryId === 'persia') {
                logToConsole(`[GAME OVER] قدرت پایگاه شما به زیر حد بحرانی رسید. سقوط فرماندهی.`, 'console-danger');
                gameActive = false;
                setButtonStates(false); 
                return;
            }
            
            logPrompt(`پایان عملیات روز ${dayCount}. آغاز شبیه‌سازی شبانه...`);
            setButtonStates(false); // غیرفعال کردن همه دکمه‌ها برای اجرای شب
            
            // 2. درآمد روزانه
            const baseIncome = gameState.mines * MARKET_PRICES.daily_income_base;
            const taxAmount = Math.floor(baseIncome * (taxRate / 100));
            const netIncome = baseIncome - taxAmount;
            
            gameState.money += netIncome;
            
            logToConsole(`[FINANCE] درآمد خالص روزانه: ${netIncome.toLocaleString()} تومان.`, 'console-system');

            // 3. اجرای جاسوسی (اگر توکن فعال باشد)
            applyEspionageDebuff();
            
            // 4. اجرای رندوم بات‌ها و شلیک هسته‌ای (با تأخیر شبیه‌سازی)
            setTimeout(() => {
                
                const nukeFired = nukeStrike();
                
                if (!nukeFired) {
                    randomBotAction();
                }
                
                // 5. بازگشت قدرت موقت به حالت پایه (این باید قبل از ریست کامل انجام شود)
                if (selectedCountryId === 'persia') {
                    const basePower = countryPowerMap[selectedCountryId].power;
                    if (gameState.power > basePower) {
                         const decay = gameState.power - basePower;
                         gameState.power = basePower;
                         logToConsole(`[REVERT] قدرت موقت ${decay.toLocaleString()} واحد کاهش یافت و به سطح ${basePower} بازگشت.`, 'console-system');
                    }
                }
                
                // چک کردن دوباره باخت پس از حمله دشمن
                if (gameState.power <= 100 && selectedCountryId === 'persia') {
                    logToConsole(`[GAME OVER] قدرت پایگاه شما پس از حمله دشمن به زیر حد بحرانی رسید.`, 'console-danger');
                    gameActive = false;
                    setButtonStates(false); 
                    return;
                }

                // 6. ریست UI و افزایش روز
                dayCount++;
                logToConsole(`*** پایان روز ${dayCount - 1} | آغاز روز ${dayCount} ***`, 'console-system');
                
                renderBotStatus();
                updateStatusBar();
                selectedBotIndex = -1; // ریست هدف
                setButtonStates(true); // **فعال‌سازی مجدد همه دکمه‌ها برای روز جدید**
                
            }, 2000);
        }

        // --- مقداردهی اولیه ---
        function initialize() {
            // انتخاب پیش‌فرض ایران
            const initialRegion = document.getElementById('region-A');
            initialRegion.click(); 
            
            logToConsole("سیستم فرماندهی تاکتیکی بارگذاری شد.", 'console-system');
            
            renderBotStatus();
            updateStatusBar();
            setButtonStates(true); // **تنظیم اولیه وضعیت دکمه‌ها**
        }

        // --- شنوندگان (Event Listeners) ---
        mapRegions.forEach(region => {
            region.addEventListener('click', function() {
                if (!gameActive) return;
                mapRegions.forEach(r => r.classList.remove('selected'));
                
                selectedCountryId = this.getAttribute('data-country-id');
                this.classList.add('selected');
                
                const countryData = countryPowerMap[selectedCountryId];
                
                logPrompt(`پایگاه فرماندهی به ${countryData.name} تغییر یافت.`);
                
                // تنظیم قدرت بر اساس منطقه انتخابی (برای استفاده در اسکن و حمله)
                gameState.power = countryData.power; 
                
                selectedBotIndex = -1;
                renderBotStatus();
                updateStatusBar();
                setButtonStates(true);
            });
        });

        btnMarket.addEventListener('click', openMarket);
        btnEndDay.addEventListener('click', advanceDay);
        btnScan.addEventListener('click', handleScan);
        btnEngage.addEventListener('click', handleEngage);

        initialize();
    </script>
</body>
</html>
